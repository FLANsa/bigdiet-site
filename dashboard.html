<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Big Diet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <style>
        .table thead th {
            padding: 20px 30px !important;
            font-size: 1.1rem !important;
            font-weight: 600 !important;
            min-width: 150px !important;
            text-align: center !important;
        }
        .table thead th:first-child {
            border-top-left-radius: 0 !important;
            border-bottom-left-radius: 0 !important;
        }
        .table thead th:last-child {
            border-top-right-radius: 0 !important;
            border-bottom-right-radius: 0 !important;
        }
        .table tbody td {
            padding: 15px 20px !important;
            text-align: center !important;
            vertical-align: middle !important;
        }
        .table tbody td:first-child {
            text-align: center !important;
            font-family: monospace !important;
        }
        .table tbody td:nth-child(2),
        .table tbody td:nth-child(3),
        .table tbody td:nth-child(4),
        .table tbody td:nth-child(5) {
            text-align: center !important;
            padding: 15px 10px !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">Big Diet</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html">لوحة التحكم</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="customers.html">العملاء</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="subscriptions.html">الاشتراكات</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="daily-registration.html">التسجيل اليومي</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="packages.html">الباقات</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button class="btn btn-outline-danger btn-sm" onclick="logout()">تسجيل الخروج</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <h1 class="mb-4">لوحة التحكم</h1>
        
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <div class="stats-number" id="totalCustomers">-</div>
                        <div class="stats-label">إجمالي العملاء</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <div class="stats-number" id="activeSubscriptions">-</div>
                        <div class="stats-label">الاشتراكات النشطة</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <div class="stats-number" id="totalPackages">-</div>
                        <div class="stats-label">الباقات المتاحة</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <div class="stats-number" id="todayMealsCollected">-</div>
                        <div class="stats-label">تسجيلات اليوم</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card" id="activityCard">
            <div class="card-header">
                <h5 class="mb-0">النشاط الأخير</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>الوقت</th>
                                <th>النشاط</th>
                                <th>العميل</th>
                                <th>التفاصيل</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Activity data will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Auth gate
      if (localStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'login.html';
      }

      // ---------- Helpers ----------
      const RIYADH_TZ = 'Asia/Riyadh';

      async function waitForFirebaseInstance(timeout = 8000) {
        const start = Date.now();
        while (!window.firebaseDB_instance) {
          if (Date.now() - start > timeout) throw new Error('Firebase not ready');
          await new Promise(r => setTimeout(r, 30));
        }
        return window.firebaseDB_instance;
      }

      // Format a local date string in Riyadh and return a Date object
      function dateInRiyadh(y, m, d, hh = 0, mm = 0, ss = 0) {
        // Compose ISO like "YYYY-MM-DDTHH:MM:SS+03:00"
        const pad = (n) => String(n).padStart(2, '0');
        const iso = `${y}-${pad(m+1)}-${pad(d)}T${pad(hh)}:${pad(mm)}:${pad(ss)}+03:00`;
        return new Date(iso);
      }

      // Parse activity.date/time that might be:
      // - "YYYY-MM-DD" and "HH:MM"
      // - Firestore Timestamp {seconds, nanoseconds}
      // Return a Date in Riyadh tz for correct month filtering/sorting
      function parseActivityDateTimeRiyadh(dateField, timeField) {
        // Timestamp
        if (dateField && typeof dateField === 'object' && typeof dateField.seconds === 'number') {
          const d = new Date(dateField.seconds * 1000);
          const y = d.toLocaleString('en-CA', { timeZone: RIYADH_TZ, year: 'numeric' });
          const m = d.toLocaleString('en-CA', { timeZone: RIYADH_TZ, month: '2-digit' }) - 1;
          const day = d.toLocaleString('en-CA', { timeZone: RIYADH_TZ, day: '2-digit' });
          const hh = Number(d.toLocaleString('en-GB', { timeZone: RIYADH_TZ, hour: '2-digit', hour12: false }));
          const mm = Number(d.toLocaleString('en-GB', { timeZone: RIYADH_TZ, minute: '2-digit' }));
          return dateInRiyadh(Number(y), m, Number(day), hh, mm, 0);
        }

        // String date + time
        if (typeof dateField === 'string') {
          const [y, m, d] = dateField.split('-').map(Number);
          let hh = 0, mm = 0;
          if (typeof timeField === 'string' && timeField.includes(':')) {
            const parts = timeField.split(':');
            hh = Number(parts[0] || 0);
            mm = Number(parts[1] || 0);
          }
          return dateInRiyadh(y, (m - 1), d, hh, mm, 0);
        }

        // Fallback: try to construct
        const fallback = new Date(dateField || Date.now());
        return new Date(fallback.toLocaleString('en-US', { timeZone: RIYADH_TZ }));
      }

      function monthNameArabic(m) {
        return [
          'يناير','فبراير','مارس','أبريل','مايو','يونيو',
          'يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'
        ][m];
      }

      // ---------- Dashboard ----------
      class Dashboard {
        constructor() {
          const now = new Date(new Date().toLocaleString('en-US', { timeZone: RIYADH_TZ }));
          this.currentMonth = now.getMonth();
          this.currentYear = now.getFullYear();
          this.currentPage = 1;
          this.pageSize = 25;

          this.$tbody = document.querySelector('#activityCard tbody');
          this.$stats = {
            totalCustomers: document.getElementById('totalCustomers'),
            activeSubscriptions: document.getElementById('activeSubscriptions'),
            totalPackages: document.getElementById('totalPackages'),
            todayMealsCollected: document.getElementById('todayMealsCollected')
          };

          // Build month nav once (inside activity card header)
          this.setupMonthNav();

          this._paginationHandlerBound = this._paginationHandler.bind(this);
          this.setupPaginationShell();

          this.init();
        }

        async init() {
          await waitForFirebaseInstance();
          await this.loadStats();
          await this.loadRecentActivity();

          // Auto-refresh stats every 30s
          this._statsInterval = setInterval(() => this.loadStats(), 30000);

          // Refresh when page becomes visible
          document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
              this.loadStats();
              this.loadRecentActivity();
            }
          });
        }

        setStatsLoading(isLoading) {
          const val = isLoading ? '—' : null;
          if (isLoading) {
            this.$stats.totalCustomers.textContent = '…';
            this.$stats.activeSubscriptions.textContent = '…';
            this.$stats.totalPackages.textContent = '…';
            this.$stats.todayMealsCollected.textContent = '…';
          }
        }

        async loadStats() {
          try {
            this.setStatsLoading(true);
            const F = window.firebaseDB_instance;
            const stats = await F.getDashboardStats();
            this.$stats.totalCustomers.textContent = stats.totalCustomers ?? 0;
            this.$stats.activeSubscriptions.textContent = stats.activeSubscriptions ?? 0;
            this.$stats.totalPackages.textContent = stats.totalPackages ?? 0;
            this.$stats.todayMealsCollected.textContent = stats.todayRegistrations ?? 0;
          } catch (e) {
            console.error('Stats error', e);
            this.$stats.totalCustomers.textContent = '—';
            this.$stats.activeSubscriptions.textContent = '—';
            this.$stats.totalPackages.textContent = '—';
            this.$stats.todayMealsCollected.textContent = '—';
          } finally {
            this.setStatsLoading(false);
          }
        }

        setActivityLoading() {
          this.$tbody.innerHTML = `
            <tr><td colspan="5" class="text-center py-4">
              <div class="spinner-border"></div>
            </td></tr>`;
        }

        async loadRecentActivity() {
          try {
            this.setActivityLoading();
            const F = window.firebaseDB_instance;

            // Load all activities, then filter current month in Riyadh
            const [activities, customers] = await Promise.all([
              F.getActivities(),
              F.getCustomers()
            ]);
            const cMap = new Map(customers.map(c => [c.id, c.name || '']));

            // Filter by selected Riyadh month
            const filtered = activities.filter(a => {
              const dt = parseActivityDateTimeRiyadh(a.date, a.time);
              return dt.getFullYear() === this.currentYear && dt.getMonth() === this.currentMonth;
            });

            // Sort desc by datetime
            filtered.sort((a, b) => {
              const da = parseActivityDateTimeRiyadh(a.date, a.time);
              const db = parseActivityDateTimeRiyadh(b.date, b.time);
              return db - da;
            });

            // Pagination
            const total = filtered.length;
            const totalPages = Math.max(1, Math.ceil(total / this.pageSize));
            if (this.currentPage > totalPages) this.currentPage = totalPages;

            const start = (this.currentPage - 1) * this.pageSize;
            const pageItems = filtered.slice(start, start + this.pageSize);

            // Render
            this.$tbody.innerHTML = '';
            if (!pageItems.length) {
              this.$tbody.innerHTML = '<tr><td colspan="5" class="text-center">لا توجد أنشطة</td></tr>';
            } else {
              pageItems.forEach(a => {
                const name = cMap.get(a.customerId) || 'عميل غير معروف';
                const timeText = a.time || '—';
                const typeText = a.type || '—';
                const desc = a.description || '—';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${timeText}</td>
                  <td>${typeText}</td>
                  <td>${name}</td>
                  <td>${desc}</td>
                  <td><span class="badge bg-success">مكتمل</span></td>
                `;
                this.$tbody.appendChild(tr);
              });
            }

            // Update pagination UI
            this.updatePagination(total, totalPages);
          } catch (e) {
            console.error('Activity error', e);
            this.$tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">تعذّر تحميل النشاط</td></tr>';
          }
        }

        setupMonthNav() {
          const cardHeader = document.querySelector('#activityCard .card-header');
          const monthNav = document.createElement('div');
          monthNav.className = 'd-flex justify-content-between align-items-center mb-3';
          monthNav.innerHTML = `
            <button class="btn btn-outline-primary" id="prevMonth">الشهر السابق</button>
            <h5 id="currentMonthDisplay">${monthNameArabic(this.currentMonth)} ${this.currentYear}</h5>
            <button class="btn btn-outline-primary" id="nextMonth">الشهر التالي</button>
          `;
          cardHeader.appendChild(monthNav);

          document.getElementById('prevMonth').addEventListener('click', async () => {
            this.currentMonth--;
            if (this.currentMonth < 0) {
              this.currentMonth = 11;
              this.currentYear--;
            }
            this.currentPage = 1;
            document.getElementById('currentMonthDisplay').textContent = `${monthNameArabic(this.currentMonth)} ${this.currentYear}`;
            await this.loadRecentActivity();
          });

          document.getElementById('nextMonth').addEventListener('click', async () => {
            this.currentMonth++;
            if (this.currentMonth > 11) {
              this.currentMonth = 0;
              this.currentYear++;
            }
            this.currentPage = 1;
            document.getElementById('currentMonthDisplay').textContent = `${monthNameArabic(this.currentMonth)} ${this.currentYear}`;
            await this.loadRecentActivity();
          });
        }

        setupPaginationShell() {
          // Create once under the activity card
          let nav = document.querySelector('#activityCard nav.pagination-shell');
          if (!nav) {
            nav = document.createElement('nav');
            nav.className = 'pagination-shell mt-3';
            nav.innerHTML = '<ul class="pagination justify-content-center mb-0"></ul>';
            document.getElementById('activityCard').appendChild(nav);
          }
          const ul = nav.querySelector('ul');
          // Replace handler safely (event delegation)
          ul.removeEventListener('click', this._paginationHandlerBound);
          ul.addEventListener('click', this._paginationHandlerBound);
        }

        _paginationHandler(e) {
          const a = e.target.closest('a[data-page]');
          if (!a) return;
          e.preventDefault();
          const p = Number(a.dataset.page);
          if (!Number.isFinite(p) || p < 1) return;
          this.currentPage = p;
          this.loadRecentActivity();
        }

        updatePagination(total, totalPages) {
          const ul = document.querySelector('#activityCard nav.pagination-shell ul');
          ul.innerHTML = '';

          const addItem = (label, page, disabled = false, active = false) => {
            const li = document.createElement('li');
            li.className = `page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${page}">${label}</a>`;
            ul.appendChild(li);
          };

          const prevPage = Math.max(1, this.currentPage - 1);
          const nextPage = Math.min(totalPages, this.currentPage + 1);

          addItem('السابق', prevPage, this.currentPage === 1);
          for (let i = 1; i <= totalPages; i++) addItem(String(i), i, false, i === this.currentPage);
          addItem('التالي', nextPage, this.currentPage === totalPages);
        }
      }

      // Global refresh function (kept for compatibility)
      window.refreshDashboard = function() {
        if (window.dashboardInstance) {
          window.dashboardInstance.loadStats();
          window.dashboardInstance.loadRecentActivity();
        }
      };

      // Initialize dashboard
      document.addEventListener('DOMContentLoaded', async () => {
        try {
          await waitForFirebaseInstance();
          window.dashboardInstance = new Dashboard();
        } catch (e) {
          console.error(e);
          alert('تعذّر تحميل لوحة التحكم. يرجى تحديث الصفحة.');
        }
      });

      // Logout
      function logout() {
        if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
          localStorage.removeItem('isLoggedIn');
          localStorage.removeItem('username');
          window.location.href = 'login.html';
        }
      }
    </script>
    
    <!-- Firebase SDK -->
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="online-database.js"></script>
</body>
</html>
