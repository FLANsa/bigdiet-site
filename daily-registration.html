<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net https://www.gstatic.com https://*.firebaseio.com https://*.googleapis.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://cdn.jsdelivr.net https://www.gstatic.com https://*.firebaseio.com https://*.googleapis.com;">
    <title>Daily Registration - Big Diet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <style>
        .table thead th {
            padding: 15px 20px !important;
            font-size: 0.9rem !important;
            font-weight: 600 !important;
            min-width: 120px !important;
            text-align: center !important;
        }
        .table thead th:first-child {
            border-top-left-radius: 0 !important;
            border-bottom-left-radius: 0 !important;
        }
        .table thead th:last-child {
            border-top-right-radius: 0 !important;
            border-bottom-right-radius: 0 !important;
            border-top-left-radius: 15px !important;
            border-bottom-left-radius: 15px !important;
        }

        .table tbody td {
            padding: 15px 20px !important;
            text-align: center !important;
            vertical-align: middle !important;
        }
        .table tbody td:first-child {
            text-align: center !important;
            font-family: monospace !important;
        }
        .table tbody td:nth-child(2),
        .table tbody td:nth-child(3),
        .table tbody td:nth-child(5) {
            text-align: center !important;
            padding: 15px 10px !important;
        }
        .table tbody td:nth-child(4) {
            text-align: center !important;
            font-weight: 600 !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <div class="logo"></div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">لوحة التحكم</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="customers.html">العملاء</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="subscriptions.html">الاشتراكات</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="daily-registration.html">التسجيل اليومي</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="packages.html">الباقات</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button class="btn btn-outline-danger btn-sm" onclick="logout()">تسجيل الخروج</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <h1 class="mb-4">التسجيل اليومي للوجبات</h1>
        
        <!-- Registration Form -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">تسجيل جديد</h5>
                    </div>
                    <div class="card-body">
                        <form id="registrationForm">
                            <div class="mb-3">
                                <label for="customerSearch" class="form-label">البحث عن العميل</label>
                                <input type="text" class="form-control" id="customerSearch" inputmode="numeric" placeholder="أدخل اسم العميل أو رقم الهاتف">
                                <div id="searchResults" class="mt-2"></div>
                            </div>
                            <div class="mb-3" id="selectedCustomerInfo" style="display: none;">
                                <div class="alert alert-info">
                                    <strong>العميل المحدد:</strong> <span id="selectedCustomerName"></span><br>
                                    <strong>الوجبات المتبقية:</strong> <span id="remainingMeals"></span><br>
                                    <strong>السناكس المتبقية:</strong> <span id="remainingSnacks"></span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="mealType" class="form-label">تسجيل الوجبات</label>
                                <select class="form-select" id="mealType">
                                    <option value="">-- اختر عدد الوجبات --</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="snackType" class="form-label">تسجيل السناكس</label>
                                <select class="form-select" id="snackType">
                                    <option value="">-- اختر عدد السناكس --</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="registrationTime" class="form-label">وقت التسجيل</label>
                                <input type="time" class="form-control" id="registrationTime" readonly>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">تسجيل الحضور</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Today's Registrations -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">تسجيلات اليوم</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="testTodayRegistrations()">اختبار</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>الوقت</th>
                                        <th>اسم العميل</th>
                                        <th>نوع التسجيل</th>
                                        <th>الكمية</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="todayRegistrationsTableBody">
                                    <!-- Today's registrations will be loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Visits Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card" id="recentVisitsSection" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">آخر الزيارات</h5>
                    </div>
                    <div class="card-body" id="recentVisitsList">
                        <!-- Recent visits will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Auth gate
      if (localStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'login.html';
      }

      // -------- Helpers --------
      const RIYADH_TZ = 'Asia/Riyadh';

      // Normalize Arabic-Indic digits and strip non-digits for phone comparisons
      function normalizeDigits(input) {
        if (!input) return '';
        const map = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
        return input.replace(/[٠-٩]/g, ch => map[ch] || ch);
      }
      function normalizePhone(input) {
        return normalizeDigits(input).replace(/\D/g, '').slice(0, 10);
      }

      // Riyadh "now" and HH:MM
      function nowInRiyadh() {
        return new Date(new Date().toLocaleString('en-US', { timeZone: RIYADH_TZ }));
      }
      function timeHMInRiyadh() {
        const d = nowInRiyadh();
        const hh = String(d.getHours()).padStart(2, '0');
        const mm = String(d.getMinutes()).padStart(2, '0');
        return `${hh}:${mm}`;
      }

      // Wait for firebase layer (module scripts load async)
      async function waitForFirebaseInstance(timeout = 8000) {
        const start = Date.now();
        while (!window.firebaseDB_instance) {
          if (Date.now() - start > timeout) throw new Error('Firebase not ready');
          await new Promise(r => setTimeout(r, 30));
        }
        return window.firebaseDB_instance;
      }

      // Debounce utility for search
      function debounce(fn, ms=200){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

      // -------- Daily Registration Manager --------
      class DailyRegistrationManager {
        constructor() {
          this.selectedCustomer = null;
          this.$search = document.getElementById('customerSearch');
          this.$results = document.getElementById('searchResults');
          this.$selectedInfo = document.getElementById('selectedCustomerInfo');
          this.$selectedName = document.getElementById('selectedCustomerName');
          this.$remainMeals = document.getElementById('remainingMeals');
          this.$remainSnacks = document.getElementById('remainingSnacks');
          this.$mealSelect = document.getElementById('mealType');
          this.$snackSelect = document.getElementById('snackType');
          this.$time = document.getElementById('registrationTime');
          this.$todayTbody = document.getElementById('todayRegistrationsTableBody');
          this.$recentSection = document.getElementById('recentVisitsSection');
          this.$recentList = document.getElementById('recentVisitsList');
          this.$submitBtn = document.querySelector('#registrationForm button[type="submit"]');
          this._submitting = false;

          this.init();
        }

        async init() {
          await waitForFirebaseInstance();
          this.setCurrentTimeRiyadh();
          this.setupEventListeners();
          this.loadTodayRegistrations();
        }

        setCurrentTimeRiyadh() {
          this.$time.value = timeHMInRiyadh();
        }

        setupEventListeners() {
          // Normalize query as user types (Arabic-Indic digits supported) - debounced
          this.$search.addEventListener('input', debounce(async (e) => {
            await this.searchCustomers(e.target.value);
          }, 250));

          // Form submission
          document.getElementById('registrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await this.submitRegistration();
          });
        }

        async searchCustomers(queryRaw) {
          const query = (queryRaw || '').trim();
          this.$results.innerHTML = '';

          if (query.length < 2) return;

          const F = window.firebaseDB_instance;
          const allCustomers = await F.getCustomers();

          // Prepare both name and phone matching; phone supports Arabic-Indic digits
          const phoneQuery = normalizePhone(query);
          const lowerQuery = query.toLowerCase();

          const filtered = allCustomers.filter(c => {
            const nameOK = (c.name || '').toLowerCase().includes(lowerQuery);
            const phoneOK = phoneQuery && (normalizePhone(c.phone || '').includes(phoneQuery));
            return nameOK || phoneOK;
          });

          if (!filtered.length) {
            this.$results.innerHTML = '<div class="text-muted">لا يوجد عملاء</div>';
            return;
          }

          filtered.slice(0, 20).forEach(customer => {
            const div = document.createElement('div');
            div.className = 'border rounded p-2 mb-1';
            div.style.cursor = 'pointer';
            div.innerHTML = `
              <strong>${customer.name || '-'}</strong><br>
              <small class="text-muted" dir="ltr">${customer.phone || '-'}</small>
            `;
            div.addEventListener('click', () => this.selectCustomer(customer));
            this.$results.appendChild(div);
          });
        }

        async selectCustomer(customer) {
          const F = window.firebaseDB_instance;
          this.selectedCustomer = customer;

          const sub = await F.getActiveSubscriptionByCustomerId(customer.id);

          // Show info
          this.$selectedName.textContent = customer.name || '-';
          this.$remainMeals.textContent = sub ? (sub.remainingMeals || 0) : 0;
          this.$remainSnacks.textContent = sub ? (sub.remainingSnacks || 0) : 0;
          this.$selectedInfo.style.display = 'block';

          // Clear search UI
          this.$search.value = '';
          this.$results.innerHTML = '';

          // Populate dropdowns
          this.updateMealSnackDropdowns(sub);

          // Recent visits (limit 5)
          await this.loadRecentVisits(customer.id);
        }

        updateMealSnackDropdowns(subscription) {
          // Reset
          this.$mealSelect.innerHTML = '<option value="">-- اختر عدد الوجبات --</option>';
          this.$snackSelect.innerHTML = '<option value="">-- اختر عدد السناكس --</option>';

          if (!subscription) {
            this.$mealSelect.disabled = true;
            this.$snackSelect.disabled = true;
            this.$mealSelect.innerHTML += '<option value="0" disabled>لا يوجد اشتراك نشط</option>';
            this.$snackSelect.innerHTML += '<option value="0" disabled>لا يوجد اشتراك نشط</option>';
            return;
          }

          const remMeals = Number(subscription.remainingMeals || 0);
          const remSnacks = Number(subscription.remainingSnacks || 0);

          this.$mealSelect.disabled = remMeals === 0;
          this.$snackSelect.disabled = remSnacks === 0;

          for (let i = 1; i <= remMeals; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = i === 1 ? 'وجبة واحدة' : (i === 2 ? 'وجبتين' : `${i} وجبات`);
            this.$mealSelect.appendChild(opt);
          }

          for (let i = 1; i <= remSnacks; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = i === 1 ? 'سناك واحد' : (i === 2 ? 'سناكين' : `${i} سناكس`);
            this.$snackSelect.appendChild(opt);
          }
        }

        async submitRegistration() {
          if (this._submitting) return;
          this._submitting = true;
          const origHTML = this.$submitBtn.innerHTML;
          this.$submitBtn.disabled = true;
          this.$submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>جاري الحفظ...';

          try {
            const F = window.firebaseDB_instance;

            if (!this.selectedCustomer) {
              alert('يرجى اختيار العميل أولاً');
              return;
            }

            const meals = parseInt(this.$mealSelect.value) || 0;
            const snacks = parseInt(this.$snackSelect.value) || 0;

            if (meals === 0 && snacks === 0) {
              alert('يرجى اختيار وجبة أو سناك واحد على الأقل');
              return;
            }

            const sub = await F.getActiveSubscriptionByCustomerId(this.selectedCustomer.id);
            if (!sub) { alert('العميل لا يملك اشتراك نشط'); return; }

            if (meals > (sub.remainingMeals || 0))   { alert('عدد الوجبات المطلوبة أكبر من المتبقي'); return; }
            if (snacks > (sub.remainingSnacks || 0)) { alert('عدد السناكس المطلوبة أكبر من المتبقي'); return; }

            await F.addDailyRegistration({
              customerId: this.selectedCustomer.id,
              meals,
              snacks
            });
            alert('تم تسجيل الحضور بنجاح');
            this.resetForm();
            await this.loadTodayRegistrations();
          } catch (e) {
            console.error(e);
            alert('تعذّر حفظ التسجيل. حاول مجددًا.');
          } finally {
            this._submitting = false;
            this.$submitBtn.disabled = false;
            this.$submitBtn.innerHTML = origHTML;
          }
        }

        resetForm() {
          this.selectedCustomer = null;
          document.getElementById('registrationForm').reset();
          this.$selectedInfo.style.display = 'none';
          this.$recentSection.style.display = 'none';
          this.$results.innerHTML = '';
          this.setCurrentTimeRiyadh();
        }

        async loadRecentVisits(customerId) {
          const F = window.firebaseDB_instance;
          // More efficient alternative (optional): implement listLatestRegistrationsForCustomer in online-database.js
          const all = await F.getDailyRegistrations();
          const recent = all
            .filter(reg => reg.customerId === customerId)
            .sort((a, b) => new Date(`${b.date} ${b.time || '00:00'}`) - new Date(`${a.date} ${a.time || '00:00'}`))
            .slice(0, 5);

          if (!recent.length) {
            this.$recentList.innerHTML = '<p class="text-muted text-center">لا توجد زيارات سابقة</p>';
          } else {
            this.$recentList.innerHTML = '';
            recent.forEach(visit => {
              const div = document.createElement('div');
              div.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
              const qty = this.formatRegistrationQuantity(visit);
              div.innerHTML = `
                <div>
                  <strong>${visit.date || '-'}</strong><br>
                  <small class="text-muted">${qty}</small>
                </div>
                <div><span class="badge bg-primary">${visit.time || '-'}</span></div>
              `;
              this.$recentList.appendChild(div);
            });
          }
          this.$recentSection.style.display = 'block';
        }

        async loadTodayRegistrations() {
          try {
            const F = window.firebaseDB_instance;

            // Loading indicator
            this.$todayTbody.innerHTML = '<tr><td colspan="6" class="text-center py-3"><div class="spinner-border"></div></td></tr>';

            console.log('Loading today\'s registrations...');
            const regs = await F.getTodayRegistrations();
            console.log('Today\'s registrations:', regs);
            
            if (!regs.length) {
              this.$todayTbody.innerHTML = '<tr><td colspan="6" class="text-center">لا توجد تسجيلات اليوم</td></tr>';
              return;
            }

            // Preload all customers once -> map by id
            const customers = await F.getCustomers();
            const cMap = new Map(customers.map(c => [c.id, c]));

            this.$todayTbody.innerHTML = '';
            regs.forEach(reg => {
              const c = cMap.get(reg.customerId);
              const name = c ? c.name : 'عميل غير معروف';
              const type = this.getRegistrationType(reg);
              const qty  = this.getRegistrationQuantity(reg);

              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${reg.time || '-'}</td>
                <td>${name}</td>
                <td>${type}</td>
                <td>${qty}</td>
                <td><span class="badge bg-success">مكتمل</span></td>
                <td>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteRegistration('${reg.id}')">حذف</button>
                </td>
              `;
              this.$todayTbody.appendChild(tr);
            });
            
            console.log('Successfully loaded', regs.length, 'today\'s registrations');
          } catch (error) {
            console.error('Error loading today\'s registrations:', error);
            this.$todayTbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">تعذّر تحميل تسجيلات اليوم: ' + error.message + '</td></tr>';
          }
        }

        getRegistrationType(reg) {
          if ((reg.meals || 0) > 0 && (reg.snacks || 0) > 0) return 'وجبات وسناكس';
          if ((reg.meals || 0) > 0) return 'وجبات';
          if ((reg.snacks || 0) > 0) return 'سناكس';
          return 'غير محدد';
        }

        getRegistrationQuantity(reg) {
          const m = Number(reg.meals || 0);
          const s = Number(reg.snacks || 0);

          let text = '';
          if (m > 0) {
            text += (m === 1) ? 'وجبة واحدة' : (m === 2) ? 'وجبتين' : `${m} وجبات`;
          }
          if (s > 0) {
            if (text) text += ' + ';
            text += (s === 1) ? 'سناك واحد' : (s === 2) ? 'سناكين' : `${s} سناكس`;
          }
          return text || 'غير محدد';
        }

        formatRegistrationQuantity(reg) { return this.getRegistrationQuantity(reg); }
      }

      // -------- Global delete using Firestore --------
      async function deleteRegistration(id) {
        const F = window.firebaseDB_instance;
        if (!id) return;

        if (!confirm('هل أنت متأكد من حذف هذا التسجيل؟')) return;

        try {
          await F.deleteDailyRegistration(id); // This also restores counters (meals/snacks) in online-database.js
          dailyRegistrationManager.loadTodayRegistrations();
          alert('تم حذف التسجيل بنجاح');
        } catch (e) {
          console.error(e);
          alert('تعذّر حذف التسجيل. حاول مجددًا.');
        }
      }

      // Initialize
      let dailyRegistrationManager;
      document.addEventListener('DOMContentLoaded', async function () {
        try {
          await waitForFirebaseInstance();
          dailyRegistrationManager = new DailyRegistrationManager();
        } catch (e) {
          console.error(e);
          alert('تعذّر تحميل الصفحة. يرجى إعادة المحاولة.');
        }
      });

      // Offline notice
      window.addEventListener('offline', () => {
        alert('الاتصال بالإنترنت غير متوفر. ستتأخر العمليات حتى يعود الاتصال.');
      });

        // Test today's registrations
        async function testTodayRegistrations() {
          try {
            console.log('Testing today\'s registrations...');
            const F = window.firebaseDB_instance;
            if (!F) {
              alert('Firebase instance not available');
              return;
            }
            
            const today = new Date().toISOString().slice(0, 10);
            console.log('Today\'s date:', today);
            
            const regs = await F.getTodayRegistrations();
            console.log('Today\'s registrations result:', regs);
            alert('Test successful!\nFound ' + (regs ? regs.length : 0) + ' registrations for today');
          } catch (error) {
            console.error('Test error:', error);
            alert('Test failed: ' + error.message);
          }
        }

        // Logout
        function logout() {
          if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
          }
        }
    </script>
    
    <!-- Firebase SDK -->
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="online-database.js"></script>
</body>
</html>

