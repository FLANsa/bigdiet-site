<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Portal - big diet</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: url('image.png') center/cover no-repeat fixed;
            min-height: 100vh;
            margin: 0;
            position: relative;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            z-index: -1;
        }
        
        .hero-section {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            margin: 30px 20px;
            padding: 80px 20px;
            text-align: center;
            color: white;
            position: relative;
            z-index: 1;
            box-shadow: 0 15px 35px rgba(40, 167, 69, 0.3);
        }
        
        .hero-section h1 {
            font-size: 3.5rem;
            font-weight: 700;
            text-shadow: 0 4px 8px rgba(0,0,0,0.2);
            margin-bottom: 1rem;
        }
        
        .hero-section p {
            font-size: 1.3rem;
            opacity: 0.95;
            font-weight: 400;
        }
        
        .main-card {
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(25px);
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            border: 1px solid rgba(40, 167, 69, 0.2);
            overflow: hidden;
            position: relative;
            z-index: 1;
            margin-top: -20px;
        }
        
        .container {
            position: relative;
            z-index: 1;
        }
        
        .card-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            padding: 50px 30px;
            text-align: center;
            position: relative;
        }
        
        .card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }
        
        .icon-circle {
            width: 90px;
            height: 90px;
            background: rgba(255,255,255,0.25);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
            font-size: 2.2rem;
            color: white;
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255,255,255,0.4);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            position: relative;
            z-index: 2;
        }
        
        .card-header h3 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 2;
        }
        
        .card-header p {
            font-size: 1.1rem;
            opacity: 0.95;
            position: relative;
            z-index: 2;
        }
        
        .form-control {
            border-radius: 15px;
            border: 2px solid #e9ecef;
            padding: 15px 20px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 15px;
            padding: 15px 30px;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
        }
        
        .stats-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            border: 2px solid rgba(40, 167, 69, 0.1);
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }
        
        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(40, 167, 69, 0.15);
            border-color: rgba(40, 167, 69, 0.3);
        }
        
        .stats-card.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .stats-card.info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .stats-card.warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
            border-color: rgba(255, 193, 7, 0.3);
        }
        
        .stats-card.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .stats-label {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .alert {
            border-radius: 15px;
            border: none;
            padding: 20px;
            font-weight: 500;
        }
        
        .alert-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }
        
        .recent-visits {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
        }
        
        .visit-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-right: 4px solid #56ab2f;
        }
        
        .navbar-brand {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .input-group-text {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%) !important;
            color: white !important;
            border: none !important;
            border-radius: 15px !important;
        }
        
        .form-control {
            border: 2px solid #e9ecef !important;
            border-radius: 15px !important;
        }
        
        .input-group .form-control {
            border-radius: 15px !important;
        }
        
        .input-group .input-group-text {
            border-radius: 15px !important;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Beautiful Header with White Background -->
    <nav class="navbar navbar-expand-lg navbar-light" style="background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
        <div class="container">
            <a class="navbar-brand text-success d-flex align-items-center" href="customer-portal.html">
                <div class="logo me-2" style="width: 40px; height: 40px;"></div>
                <div>
                    <strong>Big Diet</strong>
                    <div style="font-size: 0.9rem; opacity: 0.7;">بوابة العميل</div>
                </div>
            </a>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8 text-center">
                    <h1 class="display-4 fw-bold mb-3">مرحباً بك في big diet</h1>
                    <p class="lead mb-4">استعلم عن اشتراكك بسهولة وسرعة</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <div class="main-card">
                    <div class="card-header">
                        <div class="icon-circle">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 class="mb-2 fw-bold text-white">استعلام عن الاشتراك</h3>
                        <p class="mb-0 opacity-90 text-white">ادخل رقم هاتفك للاطلاع على تفاصيل اشتراكك</p>
                    </div>
                    <div class="card-body p-5">
                        <form id="customerInquiryForm" class="mb-4">
                            <div class="mb-4">
                                <label for="phoneNumber" class="form-label fw-semibold text-dark mb-3">رقم الهاتف</label>
                                <div class="input-group input-group-lg">
                                    <input type="tel" class="form-control" id="phoneNumber" 
                                           placeholder="05xxxxxxxx" maxlength="10" required>
                                    <span class="input-group-text">
                                        <i class="fas fa-phone"></i>
                                    </span>
                                </div>
                                <div class="form-text text-muted mt-2">يرجى إدخال رقم الهاتف المكون من 10 أرقام</div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-search me-2"></i>استعلام عن الاشتراك
                                </button>
                            </div>
                        </form>

                        <!-- Error Message -->
                        <div id="errorMessage" class="alert alert-danger" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="errorText"></span>
                        </div>

                        <!-- Subscription Details Card (Hidden by default) -->
                        <div id="subscriptionDetails" class="fade-in" style="display: none;">
                            <hr class="my-5">
                            <h4 class="text-center mb-4 fw-bold text-success">
                                <i class="fas fa-user-check me-2"></i>تفاصيل الاشتراك
                            </h4>
                            
                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <div class="stats-card">
                                        <div class="card-body text-center p-4">
                                            <div class="stats-number" id="customerName">-</div>
                                            <div class="stats-label">اسم العميل</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="stats-card">
                                        <div class="card-body text-center p-4">
                                            <div class="stats-number" id="packageName">-</div>
                                            <div class="stats-label">الباقة الحالية</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <div class="stats-card success">
                                        <div class="card-body text-center p-4">
                                            <div class="stats-number" id="daysLeft">-</div>
                                            <div class="stats-label">الأيام المتبقية</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="stats-card info">
                                        <div class="card-body text-center p-4">
                                            <div class="stats-number" id="endDate">-</div>
                                            <div class="stats-label">تاريخ الانتهاء</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="stats-card warning">
                                        <div class="card-body text-center p-4">
                                            <div class="stats-number" id="remainingMeals">-</div>
                                            <div class="stats-label">الوجبات المتبقية</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="stats-card danger">
                                        <div class="card-body text-center p-4">
                                            <div class="stats-number" id="remainingSnacks">-</div>
                                            <div class="stats-label">السناكس المتبقية</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Visits Section -->
                            <div class="recent-visits">
                                <h5 class="fw-bold text-center mb-4">
                                    <i class="fas fa-history me-2"></i>آخر الزيارات
                                </h5>
                                <div id="recentVisitsList">
                                    <!-- Recent visits will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Utilities
      const RIYADH_TZ = 'Asia/Riyadh';

      // Normalize Arabic-Indic numerals to Western digits and strip non-digits
      function normalizePhone(input) {
        if (!input) return '';
        const arabicIndicMap = {
          '٠':'0','١':'1','٢':'2','٣':'3','٤':'4',
          '٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'
        };
        const converted = input.replace(/[٠-٩]/g, ch => arabicIndicMap[ch] || ch);
        return converted.replace(/\D/g, '').slice(0, 10); // keep max 10 digits
      }

      // Now in Riyadh time (device-agnostic)
      function nowInRiyadh() {
        // Create a Date from a localized string forced to Asia/Riyadh
        return new Date(new Date().toLocaleString('en-US', { timeZone: RIYADH_TZ }));
      }

      // Parse "YYYY-MM-DD" as midnight in Riyadh (+03:00 fixed, no DST)
      function parseRiyadhDateYYYYMMDD(dateStr) {
        if (!dateStr) return null;
        // Asia/Riyadh is UTC+3 year-round
        return new Date(dateStr + 'T00:00:00+03:00');
      }

      // Days left between two dates in Riyadh (ceil; never negative)
      function daysLeftRiyadh(endDateStr) {
        const now = nowInRiyadh();
        const end = parseRiyadhDateYYYYMMDD(endDateStr);
        if (!end) return 0;
        const msPerDay = 1000 * 60 * 60 * 24;
        const diff = Math.ceil((end - now) / msPerDay);
        return Math.max(0, diff);
      }

      class CustomerPortal {
        constructor() {
          this.$form = document.getElementById('customerInquiryForm');
          this.$phone = document.getElementById('phoneNumber');
          this.$error = document.getElementById('errorMessage');
          this.$errorText = document.getElementById('errorText');
          this.$details = document.getElementById('subscriptionDetails');
          this.$recentList = document.getElementById('recentVisitsList');
          this.$submitBtn = this.$form.querySelector('button[type="submit"]');
          this.originalBtnHTML = this.$submitBtn.innerHTML;

          this.setupEventListeners();
        }

        setupEventListeners() {
          this.$form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.searchCustomer();
          });

          // Phone formatting: allow Arabic/Indic & Western digits; strip separators
          this.$phone.addEventListener('input', (e) => {
            const normalized = normalizePhone(e.target.value);
            e.target.value = normalized;
          });
        }

        setLoading(isLoading) {
          if (isLoading) {
            this.$submitBtn.disabled = true;
            this.$submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>جاري البحث...';
          } else {
            this.$submitBtn.disabled = false;
            this.$submitBtn.innerHTML = this.originalBtnHTML;
          }
        }

        async searchCustomer() {
          const raw = this.$phone.value.trim();
          const phoneNumber = normalizePhone(raw);

          // Hide previous results
          this.$error.style.display = 'none';
          this.$details.style.display = 'none';

          // Validate phone number (must be exactly 10 digits)
          if (!phoneNumber || phoneNumber.length !== 10) {
            this.showError('يرجى إدخال رقم هاتف صحيح مكون من 10 أرقام');
            return;
          }

          try {
            this.setLoading(true);

            // 1) Get customer from Firebase
            const customer = await window.firebaseDB_instance.getCustomerByPhone(phoneNumber);
            if (!customer) {
              this.showError('لم يتم العثور على عميل بهذا الرقم');
              return;
            }

            // 2) Get customer's active subscription
            const subscription = await window.firebaseDB_instance.getActiveSubscriptionByCustomerId(customer.id);
            if (!subscription) {
              this.showError('لا يوجد اشتراك نشط لهذا العميل');
              return;
            }

            // 3) Get package data
            const packageData = await window.firebaseDB_instance.getPackageById(subscription.packageId);

            // 4) Render details
            await this.displaySubscriptionDetails(customer, subscription, packageData);
          } catch (err) {
            console.error('Error searching customer:', err);
            this.showError('حدث خطأ أثناء البحث. يرجى المحاولة مرة أخرى.');
          } finally {
            this.setLoading(false);
          }
        }

        showError(message) {
          this.$errorText.textContent = message;
          this.$error.style.display = 'block';
        }

        async displaySubscriptionDetails(customer, subscription, packageData) {
          // Calculate days left using Riyadh time
          const daysLeft = daysLeftRiyadh(subscription.endDate);

          // Update display
          document.getElementById('customerName').textContent = customer.name || '-';
          document.getElementById('packageName').textContent = (packageData && packageData.name) ? packageData.name : 'غير محدد';
          document.getElementById('daysLeft').textContent = daysLeft;
          document.getElementById('endDate').textContent = subscription.endDate || '-';
          document.getElementById('remainingMeals').textContent = subscription.remainingMeals ?? '-';
          document.getElementById('remainingSnacks').textContent = subscription.remainingSnacks ?? '-';

          // Load recent visits (limit to latest 5 for this customer)
          await this.loadRecentVisits(customer.id);

          // Show with animation
          this.$details.style.display = 'block';
          this.$details.classList.add('fade-in');
        }

        async loadRecentVisits(customerId) {
          // Use the optimized function to get customer-specific registrations
          const recent = await window.firebaseDB_instance.listDailyRegistrationsByCustomer(customerId, 10);

          if (!recent.length) {
            this.$recentList.innerHTML = '<div class="text-center text-muted py-4">لا توجد زيارات سابقة</div>';
            return;
          }

          this.$recentList.innerHTML = recent.map(visit => {
            const desc = this.formatVisitDescription(visit);
            return `
              <div class="visit-item">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>${visit.date || '-'}</strong>
                    <div class="text-muted">${visit.time || '-'}</div>
                  </div>
                  <div class="text-end">
                    <div class="fw-semibold">${desc}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }

        formatVisitDescription(reg) {
          let parts = [];
          const meals = Number(reg.meals || 0);
          const snacks = Number(reg.snacks || 0);

          if (meals > 0) {
            if (meals === 1) parts.push('وجبة واحدة');
            else if (meals === 2) parts.push('وجبتين');
            else parts.push(`${meals} وجبات`);
          }
          if (snacks > 0) {
            if (snacks === 1) parts.push('سناك');
            else if (snacks === 2) parts.push('سناكين');
            else parts.push(`${snacks} سناكس`);
          }
          return parts.join(' و ') || 'لا توجد تفاصيل';
        }
      }

      // Initialize customer portal
      let customerPortal;
      document.addEventListener('DOMContentLoaded', function() {
        customerPortal = new CustomerPortal();
      });
    </script>
    
    <!-- Firebase SDK -->
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="online-database.js"></script>
</body>
</html>

