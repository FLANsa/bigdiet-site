<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Portal - big diet</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: url('image.png') center/cover no-repeat fixed;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1;
        }
        
        .main-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,.3);
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            position: relative;
            z-index: 2;
        }
        
        .card-header {
            margin-bottom: 1.5rem;
        }
        
        .logo {
            display: block;
            width: 180px;
            max-width: 50vw;
            height: auto;
            margin: 0 auto 1.5rem;
            background: none !important;
            border: 0 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            filter: none !important;
            image-rendering: auto;
        }
        
        @media (max-width: 480px) {
            .logo {
                width: 140px;
            }
        }
        
        
        .card-header p {
            color: #6c757d;
            margin: 0;
            font-size: 1.2rem;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .form-control {
            border-radius: 15px;
            border: 2px solid #e9ecef;
            padding: 15px 20px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #4a7c59;
            box-shadow: 0 0 0 0.2rem rgba(74, 124, 89, 0.25);
        }
        
        .btn-primary {
            background: #4a7c59;
            border: none;
            border-radius: 15px;
            padding: 15px 30px;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: #3a6c49;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 2px solid rgba(74, 124, 89, 0.2);
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
            box-shadow: 0 2px 8px rgba(74, 124, 89, 0.1);
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 124, 89, 0.2);
            border-color: rgba(74, 124, 89, 0.4);
        }
        
        .stats-card.success {
            background: linear-gradient(135deg, #4a7c59 0%, #5a8a5a 100%);
            color: white;
            border-color: #4a7c59;
            box-shadow: 0 4px 12px rgba(74, 124, 89, 0.3);
        }
        
        .stats-card.info {
            background: linear-gradient(135deg, #5a8a5a 0%, #6ba86b 100%);
            color: white;
            border-color: #5a8a5a;
            box-shadow: 0 4px 12px rgba(90, 138, 90, 0.3);
        }
        
        .stats-card.warning {
            background: linear-gradient(135deg, #6ba86b 0%, #7ba87b 100%);
            color: white;
            border-color: #6ba86b;
            box-shadow: 0 4px 12px rgba(107, 168, 107, 0.3);
        }
        
        .stats-card.danger {
            background: linear-gradient(135deg, #7ba87b 0%, #8bb88b 100%);
            color: white;
            border-color: #7ba87b;
            box-shadow: 0 4px 12px rgba(123, 168, 123, 0.3);
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .stats-label {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .recent-visits .list-group-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid rgba(74, 124, 89, 0.2);
            border-radius: 10px;
            margin-bottom: 8px;
            padding: 12px 16px;
            transition: all 0.3s ease;
        }
        
        .recent-visits .list-group-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(74, 124, 89, 0.15);
            border-color: rgba(74, 124, 89, 0.4);
        }
        
        .recent-visits .badge {
            background: linear-gradient(135deg, #4a7c59 0%, #5a8a5a 100%);
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-weight: 500;
        }
        
        .alert {
            border-radius: 15px;
            border: none;
            padding: 20px;
            font-weight: 500;
        }
        
        .alert-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }
        
        .recent-visits {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
        }
        
        .visit-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-right: 4px solid #56ab2f;
        }
        
        .navbar-brand {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .input-group-text {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%) !important;
            color: white !important;
            border: none !important;
            border-radius: 15px !important;
        }
        
        .form-control {
            border: 2px solid #e9ecef !important;
            border-radius: 15px !important;
        }
        
        .input-group .form-control {
            border-radius: 15px !important;
        }
        
        .input-group .input-group-text {
            border-radius: 15px !important;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            
            .hero-section {
                margin: 15px 10px;
                padding: 40px 15px;
                border-radius: 20px;
            }
            
            .hero-section h1 {
                font-size: 2.2rem;
                margin-bottom: 0.8rem;
            }
            
            .hero-section p {
                font-size: 1.1rem;
            }
            
            .main-card {
                margin: -10px 10px 20px;
                border-radius: 20px;
            }
            
            .card-header {
                padding: 30px 20px;
            }
            
            .icon-circle {
                width: 70px;
                height: 70px;
                margin-bottom: 20px;
                font-size: 1.8rem;
            }
            
            .card-header h3 {
                font-size: 1.8rem;
                margin-bottom: 12px;
            }
            
            .card-header p {
                font-size: 1rem;
            }
            
            .card-body {
                padding: 2rem 1.5rem !important;
            }
            
            .form-control {
                padding: 14px 16px;
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 12px;
                border: 2px solid #e9ecef;
                transition: all 0.3s ease;
            }
            
            .form-control:focus {
                border-color: #5a8a5a;
                box-shadow: 0 0 0 0.2rem rgba(90, 138, 90, 0.25);
                transform: translateY(-1px);
            }
            
            .btn-primary {
                padding: 16px 24px;
                font-size: 1.1rem;
                font-weight: 600;
                border-radius: 12px;
                background: linear-gradient(135deg, #4a7c59 0%, #5a8a5a 50%, #6ba86b 100%);
                border: none;
                box-shadow: 0 4px 15px rgba(74, 124, 89, 0.3);
                transition: all 0.3s ease;
                width: 100%;
            }
            
            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(74, 124, 89, 0.4);
            }
            
            .btn-primary:active {
                transform: translateY(0);
            }
            
            .form-label {
                font-weight: 600;
                color: #495057;
                margin-bottom: 10px;
                font-size: 1rem;
            }
            
            .input-group .input-group-text {
                border-radius: 12px;
                background: #f8f9fa;
                border: 2px solid #e9ecef;
                color: #5a8a5a;
                font-size: 1.1rem;
            }
            
            .stats-card {
                margin-bottom: 1rem;
                border-radius: 15px;
            }
            
            .stats-card .card-body {
                padding: 1.5rem !important;
            }
            
            .stats-number {
                font-size: 2rem;
                margin-bottom: 8px;
            }
            
            .stats-label {
                font-size: 0.9rem;
            }
            
            .alert {
                border-radius: 12px;
                padding: 12px 16px;
                font-size: 0.95rem;
                border: none;
                margin-top: 1rem;
            }
            
            .navbar {
                padding: 0.75rem 1rem;
            }
            
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .navbar-brand .logo {
                width: 35px;
                height: 35px;
            }
            
            .subscription-details {
                padding: 1.5rem;
                border-radius: 15px;
                margin-top: 1.5rem;
            }
            
            .subscription-details h4 {
                font-size: 1.3rem;
                margin-bottom: 1rem;
            }
            
            .subscription-details .row {
                margin: 0 -0.5rem;
            }
            
            .subscription-details .col-md-6 {
                padding: 0 0.5rem;
                margin-bottom: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .hero-section {
                margin: 10px 5px;
                padding: 30px 10px;
                border-radius: 15px;
            }
            
            .hero-section h1 {
                font-size: 1.8rem;
                margin-bottom: 0.6rem;
            }
            
            .hero-section p {
                font-size: 1rem;
            }
            
            .main-card {
                margin: -5px 5px 15px;
                border-radius: 15px;
            }
            
            .card-header {
                padding: 25px 15px;
            }
            
            .icon-circle {
                width: 60px;
                height: 60px;
                margin-bottom: 15px;
                font-size: 1.5rem;
            }
            
            .card-header h3 {
                font-size: 1.5rem;
                margin-bottom: 10px;
            }
            
            .card-header p {
                font-size: 0.9rem;
            }
            
            .card-body {
                padding: 1.5rem 1rem !important;
            }
            
            .form-control {
                padding: 16px 16px;
                font-size: 16px;
            }
            
            .btn-primary {
                padding: 18px 20px;
                font-size: 1.05rem;
            }
            
            .stats-card .card-body {
                padding: 1.25rem !important;
            }
            
            .stats-number {
                font-size: 1.8rem;
            }
            
            .stats-label {
                font-size: 0.85rem;
            }
            
            .subscription-details {
                padding: 1.25rem;
                border-radius: 12px;
            }
            
            .subscription-details h4 {
                font-size: 1.2rem;
            }
        }
        
        /* Landscape orientation for mobile */
        @media (max-height: 600px) and (orientation: landscape) {
            .hero-section {
                margin: 10px 15px;
                padding: 25px 20px;
            }
            
            .hero-section h1 {
                font-size: 1.6rem;
                margin-bottom: 0.5rem;
            }
            
            .hero-section p {
                font-size: 0.9rem;
            }
            
            .main-card {
                margin: -5px 15px 10px;
            }
            
            .card-header {
                padding: 20px 25px;
            }
            
            .icon-circle {
                width: 50px;
                height: 50px;
                margin-bottom: 10px;
                font-size: 1.3rem;
            }
            
            .card-header h3 {
                font-size: 1.4rem;
                margin-bottom: 8px;
            }
            
            .card-header p {
                font-size: 0.85rem;
            }
            
            .card-body {
                padding: 1.5rem 1.25rem !important;
            }
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .btn-primary:hover {
                transform: none;
                box-shadow: 0 4px 15px rgba(74, 124, 89, 0.3);
            }
            
            .stats-card:hover {
                transform: none;
                box-shadow: 0 15px 30px rgba(90, 138, 90, 0.25);
            }
            
            .form-control:focus {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <div class="main-card">
        <div class="card-header text-center">
            <img src="logo.png" alt="Big Diet" class="logo" />
            <p>تعال شوف اشتراكك! 😊</p>
        </div>
        <form id="customerInquiryForm" class="mb-4">
            <div class="mb-3">
                <label for="phoneNumber" class="form-label">أدخل رقمك هنا 👇</label>
                <input type="tel" class="form-control" id="phoneNumber" 
                       placeholder="05xxxxxxxx" maxlength="10" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">خلاص، ابحث! 🔍</button>
        </form>

        <!-- Error Message -->
        <div id="errorMessage" class="alert alert-danger" style="display: none;">
            <span id="errorText"></span>
        </div>

        <!-- Subscription Details Card (Hidden by default) -->
        <div id="subscriptionDetails" class="fade-in" style="display: none;">
            <hr class="my-4">
            <h4 class="text-center mb-4 fw-bold" style="color: #4a7c59; font-size: 1.8rem; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                هاي اشتراكك! 🎉
            </h4>
                            
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="stats-card">
                        <div class="card-body text-center p-3">
                            <div class="stats-number" id="customerName">-</div>
                            <div class="stats-label">اسمك الحلو 😊</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stats-card">
                        <div class="card-body text-center p-3">
                            <div class="stats-number" id="packageName">-</div>
                            <div class="stats-label">الباقة اللي اخترتها 🍽️</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="stats-card success">
                        <div class="card-body text-center p-3">
                            <div class="stats-number" id="daysLeft">-</div>
                            <div class="stats-label">كم يوم باقي؟ ⏰</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stats-card info">
                        <div class="card-body text-center p-3">
                            <div class="stats-number" id="endDate">-</div>
                            <div class="stats-label">متى ينتهي؟ 📅</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <div class="stats-card warning">
                        <div class="card-body text-center p-3">
                            <div class="stats-number" id="remainingMeals">-</div>
                            <div class="stats-label">كم وجبة باقية؟ 🍽️</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stats-card danger">
                        <div class="card-body text-center p-3">
                            <div class="stats-number" id="remainingSnacks">-</div>
                            <div class="stats-label">كم سناك باقي؟ 🍿</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Visits Section -->
            <div class="recent-visits">
                <h5 class="fw-bold text-center mb-4" style="color: #4a7c59; font-size: 1.4rem; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                    آخر مرات جيت عندنا 🏃‍♂️
                </h5>
                <div id="recentVisitsList">
                    <!-- Recent visits will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Utilities
      const RIYADH_TZ = 'Asia/Riyadh';

      // Normalize Arabic-Indic numerals to Western digits and strip non-digits
      function normalizePhone(input) {
        if (!input) return '';
        const arabicIndicMap = {
          '٠':'0','١':'1','٢':'2','٣':'3','٤':'4',
          '٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'
        };
        const converted = input.replace(/[٠-٩]/g, ch => arabicIndicMap[ch] || ch);
        return converted.replace(/\D/g, '').slice(0, 10); // keep max 10 digits
      }

      // Now in Riyadh time (device-agnostic)
      function nowInRiyadh() {
        // Create a Date from a localized string forced to Asia/Riyadh
        return new Date(new Date().toLocaleString('en-US', { timeZone: RIYADH_TZ }));
      }

      // Parse "YYYY-MM-DD" as midnight in Riyadh (+03:00 fixed, no DST)
      function parseRiyadhDateYYYYMMDD(dateStr) {
        if (!dateStr) return null;
        // Asia/Riyadh is UTC+3 year-round
        return new Date(dateStr + 'T00:00:00+03:00');
      }

      // Days left between two dates in Riyadh (ceil; never negative)
      function daysLeftRiyadh(endDateStr) {
        const now = nowInRiyadh();
        const end = parseRiyadhDateYYYYMMDD(endDateStr);
        if (!end) return 0;
        const msPerDay = 1000 * 60 * 60 * 24;
        const diff = Math.ceil((end - now) / msPerDay);
        return Math.max(0, diff);
      }

      class CustomerPortal {
        constructor() {
          this.$form = document.getElementById('customerInquiryForm');
          this.$phone = document.getElementById('phoneNumber');
          this.$error = document.getElementById('errorMessage');
          this.$errorText = document.getElementById('errorText');
          this.$details = document.getElementById('subscriptionDetails');
          this.$recentList = document.getElementById('recentVisitsList');
          this.$submitBtn = this.$form.querySelector('button[type="submit"]');
          this.originalBtnHTML = this.$submitBtn.innerHTML;

          this.setupEventListeners();
        }

        setupEventListeners() {
          this.$form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.searchCustomer();
          });

          // Phone formatting: allow Arabic/Indic & Western digits; strip separators
          this.$phone.addEventListener('input', (e) => {
            const normalized = normalizePhone(e.target.value);
            e.target.value = normalized;
          });
        }

        setLoading(isLoading) {
          if (isLoading) {
            this.$submitBtn.disabled = true;
            this.$submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>دور عليك... 🔍';
          } else {
            this.$submitBtn.disabled = false;
            this.$submitBtn.innerHTML = this.originalBtnHTML;
          }
        }

        async searchCustomer() {
          const raw = this.$phone.value.trim();
          const phoneNumber = normalizePhone(raw);

          // Hide previous results
          this.$error.style.display = 'none';
          this.$details.style.display = 'none';

          // Validate phone number (must be exactly 10 digits)
          if (!phoneNumber || phoneNumber.length !== 10) {
            this.showError('يا حبيبي، أدخل رقمك كامل (10 أرقام) 😅');
            return;
          }

          try {
            this.setLoading(true);

            // 1) Get customer from Firebase
            const customer = await window.firebaseDB_instance.getCustomerByPhone(phoneNumber);
            if (!customer) {
              this.showError('ما لقيتك في النظام، تأكد من الرقم! 🤔');
              return;
            }

            // 2) Get customer's active subscription
            const subscription = await window.firebaseDB_instance.getActiveSubscriptionByCustomerId(customer.id);
            if (!subscription) {
              this.showError('ما عندك اشتراك نشط حالياً، روح اشترك! 💪');
              return;
            }

            // 3) Get package data
            const packageData = await window.firebaseDB_instance.getPackageById(subscription.packageId);

            // 4) Render details
            await this.displaySubscriptionDetails(customer, subscription, packageData);
          } catch (err) {
            console.error('Error searching customer:', err);
            this.showError('أوبس! حصل خطأ، جرب مرة ثانية 😊');
          } finally {
            this.setLoading(false);
          }
        }

        showError(message) {
          this.$errorText.textContent = message;
          this.$error.style.display = 'block';
        }

        async displaySubscriptionDetails(customer, subscription, packageData) {
          // Calculate days left using Riyadh time
          const daysLeft = daysLeftRiyadh(subscription.endDate);

          // Update display
          document.getElementById('customerName').textContent = customer.name || '-';
          document.getElementById('packageName').textContent = (packageData && packageData.name) ? packageData.name : 'غير محدد';
          document.getElementById('daysLeft').textContent = daysLeft;
          document.getElementById('endDate').textContent = subscription.endDate || '-';
          document.getElementById('remainingMeals').textContent = subscription.remainingMeals ?? '-';
          document.getElementById('remainingSnacks').textContent = subscription.remainingSnacks ?? '-';

          // Load recent visits (limit to latest 5 for this customer)
          await this.loadRecentVisits(customer.id);

          // Show with animation
          this.$details.style.display = 'block';
          this.$details.classList.add('fade-in');
        }

        async loadRecentVisits(customerId) {
          // Use the optimized function to get customer-specific registrations
          const recent = await window.firebaseDB_instance.listDailyRegistrationsByCustomer(customerId, 10);

          if (!recent.length) {
            this.$recentList.innerHTML = '<div class="text-center text-muted py-4">ما جيت عندنا بعد! تعال نشوفك 😊</div>';
            return;
          }

          this.$recentList.innerHTML = recent.map(visit => {
            const desc = this.formatVisitDescription(visit);
            return `
              <div class="visit-item">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>${visit.date || '-'}</strong>
                    <div class="text-muted">${visit.time || '-'}</div>
                  </div>
                  <div class="text-end">
                    <div class="fw-semibold">${desc}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }

        formatVisitDescription(reg) {
          let parts = [];
          const meals = Number(reg.meals || 0);
          const snacks = Number(reg.snacks || 0);

          if (meals > 0) {
            if (meals === 1) parts.push('وجبة واحدة');
            else if (meals === 2) parts.push('وجبتين');
            else parts.push(`${meals} وجبات`);
          }
          if (snacks > 0) {
            if (snacks === 1) parts.push('سناك');
            else if (snacks === 2) parts.push('سناكين');
            else parts.push(`${snacks} سناكس`);
          }
          return parts.join(' و ') || 'لا توجد تفاصيل';
        }
      }

      // Initialize customer portal
      let customerPortal;
      document.addEventListener('DOMContentLoaded', function() {
        customerPortal = new CustomerPortal();
      });
    </script>
    
    <!-- Firebase SDK -->
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="online-database.js"></script>
</body>
</html>

