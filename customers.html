<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net https://www.gstatic.com https://*.firebaseio.com https://*.googleapis.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://cdn.jsdelivr.net https://www.gstatic.com https://*.firebaseio.com https://*.googleapis.com;">
    <title>Customers - Big Diet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <style>
        .table thead th {
            padding: 20px 30px !important;
            font-size: 1.1rem !important;
            font-weight: 600 !important;
            min-width: 150px !important;
            text-align: center !important;
        }
        .table thead th:first-child {
            border-top-left-radius: 0 !important;
            border-bottom-left-radius: 0 !important;
        }
        .table thead th:last-child {
            border-top-right-radius: 0 !important;
            border-bottom-right-radius: 0 !important;
        }
        .table tbody td {
            padding: 15px 20px !important;
            text-align: center !important;
            vertical-align: middle !important;
        }
        .table tbody td:first-child {
            text-align: center !important;
            font-family: monospace !important;
        }
        .table tbody td:nth-child(2),
        .table tbody td:nth-child(3),
        .table tbody td:nth-child(4),
        .table tbody td:nth-child(5),
        .table tbody td:nth-child(6) {
            text-align: center !important;
            padding: 15px 10px !important;
        }
        .table tbody td:nth-child(4) {
            font-family: monospace !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <div class="logo"></div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">لوحة التحكم</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="customers.html">العملاء</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="subscriptions.html">الاشتراكات</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="daily-registration.html">التسجيل اليومي</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="packages.html">الباقات</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button class="btn btn-outline-danger btn-sm" onclick="logout()">تسجيل الخروج</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>إدارة العملاء</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">إضافة عميل</button>
        </div>

        <!-- Customers Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>تاريخ التسجيل</th>
                                <th>نوع العميل</th>
                                <th>اسم العميل</th>
                                <th>رقم الهاتف</th>
                                <th>الباقة الحالية</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <!-- Customers will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة عميل جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCustomerForm">
                        <div class="mb-3">
                            <label for="customerName" class="form-label">اسم العميل</label>
                            <input type="text" class="form-control" id="customerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label">رقم الهاتف (10 أرقام)</label>
                            <input type="tel" class="form-control" id="customerPhone" maxlength="10" required>
                            <div class="form-text">يجب أن يكون رقم الهاتف 10 أرقام فقط</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addCustomer()">إضافة العميل</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Customer Modal -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تعديل العميل</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm">
                        <input type="hidden" id="editCustomerId">
                        <div class="mb-3">
                            <label for="editCustomerName" class="form-label">اسم العميل</label>
                            <input type="text" class="form-control" id="editCustomerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label">رقم الهاتف (10 أرقام)</label>
                            <input type="tel" class="form-control" id="editCustomerPhone" maxlength="10" readonly>
                            <div class="form-text">رقم الهاتف هو معرف الحساب ولا يمكن تغييره</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateCustomer()">حفظ التغييرات</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Auth gate
      if (localStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'login.html';
      }

      // ------- Helpers -------
      const RIYADH_TZ = 'Asia/Riyadh';

      // Normalize Arabic-Indic digits and strip non-digits
      function normalizePhone(input) {
        if (!input) return '';
        const map = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
        const converted = input.replace(/[٠-٩]/g, ch => map[ch] || ch);
        return converted.replace(/\D/g, '').slice(0, 10);
      }

      function badgeClass(status) {
        switch (status) {
          case 'نشط': return 'bg-success';
          case 'جديد': return 'bg-primary';
          case 'منتهي': return 'bg-danger';
          default: return 'bg-secondary';
        }
      }

      // Wait until the firebaseDB_instance is ready (module scripts load async)
      async function waitForFirebaseInstance(timeout = 8000) {
        const start = Date.now();
        while (!window.firebaseDB_instance) {
          if (Date.now() - start > timeout) throw new Error('Firebase not ready');
          await new Promise(r => setTimeout(r, 30));
        }
        return window.firebaseDB_instance;
      }

      class CustomerManager {
        constructor() {
          this.$tbody = document.getElementById('customersTableBody');
          this.setupEventListeners();
          this.loadCustomers();
        }

        setupEventListeners() {
          // Add form: accept Arabic digits & only numbers, max 10
          document.getElementById('customerPhone').addEventListener('input', (e) => {
            e.target.value = normalizePhone(e.target.value);
          });

          // Edit form: display phone but keep it read-only (immutable ID)
          document.getElementById('editCustomerPhone').addEventListener('input', (e) => {
            // Just normalize visual value in case of pasting; it won't be saved
            e.target.value = normalizePhone(e.target.value);
          });
        }

        async loadCustomers() {
          try {
            // Show loading state
            this.$tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><div class="spinner-border"></div></td></tr>';
            
            const F = window.firebaseDB_instance;
            if (!F) {
              throw new Error('Firebase instance not available');
            }

            console.log('Loading customers from Firebase...');
            
            // 1) Fetch all customers
            const customers = await F.getCustomers();
            console.log('Fetched customers:', customers);
            
            if (!customers || customers.length === 0) {
              this.$tbody.innerHTML = '<tr><td colspan="7" class="text-center">لا يوجد عملاء</td></tr>';
              return;
            }

            // 2) In parallel, fetch each customer's active subscription
            const subs = await Promise.all(customers.map(c => F.getActiveSubscriptionByCustomerId(c.id)));
            // 3) Build a unique set of packageIds to fetch once
            const uniquePkgIds = [...new Set(subs.filter(Boolean).map(s => s.packageId))];
            const pkgMap = {};
            await Promise.all(uniquePkgIds.map(async (pid) => {
              const p = await F.getPackageById(pid);
              if (p) pkgMap[pid] = p;
            }));

            // 4) Render rows
            this.$tbody.innerHTML = '';
            customers.forEach((customer, idx) => {
              const sub = subs[idx] || null;
              const pkgName = sub ? (pkgMap[sub.packageId]?.name || 'لا يوجد اشتراك') : 'لا يوجد اشتراك';
              const regDate = customer.registrationDate || '-';
              const kind = sub ? 'مشترك' : 'عميل جديد';
              const bClass = badgeClass(customer.status);

              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${regDate}</td>
                <td>${kind}</td>
                <td>${customer.name || '-'}</td>
                <td>${customer.phone || '-'}</td>
                <td>${pkgName}</td>
                <td><span class="badge ${bClass}">${customer.status || '-'}</span></td>
                <td>
                  <button class="btn btn-sm btn-outline-primary me-1" onclick="editCustomer('${customer.id}')">تعديل</button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer('${customer.id}')">حذف</button>
                </td>
              `;
              this.$tbody.appendChild(tr);
            });
            
            console.log('Successfully loaded', customers.length, 'customers');
          } catch (error) {
            console.error('Error loading customers:', error);
            this.$tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">تعذّر تحميل العملاء: ' + error.message + '</td></tr>';
          }
        }
      }

      // ------- Global actions -------
      async function addCustomer() {
        const F = window.firebaseDB_instance;
        const nameEl = document.getElementById('customerName');
        const phoneEl = document.getElementById('customerPhone');

        const name = (nameEl.value || '').trim();
        const phone = normalizePhone(phoneEl.value || '');

        if (!name) { alert('يرجى إدخال اسم العميل'); return; }
        if (!F.validatePhoneNumber(phone)) { alert('رقم الهاتف يجب أن يكون 10 أرقام فقط'); return; }

        // Prevent duplicate phone (docId)
        const existing = await F.getCustomerByPhone(phone);
        if (existing) { alert('رقم الهاتف مسجل مسبقاً'); return; }

        // Create doc with id = phone (immutable)
        const customer = await F.addCustomer({ name, phone });

        await F.logActivity({
          type: 'إضافة عميل',
          customerId: customer.id,
          description: `تم إضافة العميل ${name}`
        });

        bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
        document.getElementById('addCustomerForm').reset();
        customerManager.loadCustomers();
        alert('تم إضافة العميل بنجاح');
      }

      async function editCustomer(id) {
        const F = window.firebaseDB_instance;
        const customer = await F.getCustomerById(id);
        if (!customer) return;

        document.getElementById('editCustomerId').value = id;
        document.getElementById('editCustomerName').value = customer.name || '';
        document.getElementById('editCustomerPhone').value = customer.phone || '';
        // Ensure read-only every time modal opens (phone is immutable ID)
        document.getElementById('editCustomerPhone').setAttribute('readonly', 'true');

        new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
      }

      async function updateCustomer() {
        const F = window.firebaseDB_instance;

        const id = document.getElementById('editCustomerId').value;
        const name = (document.getElementById('editCustomerName').value || '').trim();
        const phoneDisplayed = normalizePhone(document.getElementById('editCustomerPhone').value || '');

        if (!name) { alert('يرجى إدخال اسم العميل'); return; }

        // Enforce immutability: block attempts to change phone
        if (phoneDisplayed !== id) {
          alert('رقم الهاتف هو معرف الحساب ولا يمكن تغييره.\nإذا كان لابد من تغييره، أنشئ عميلًا جديدًا بالرقم الصحيح ثم احذف القديم.');
          // restore displayed phone back to id for consistency
          document.getElementById('editCustomerPhone').value = id;
          return;
        }

        await F.updateCustomer(id, { name });

        await F.logActivity({
          type: 'تعديل عميل',
          customerId: id,
          description: `تم تعديل بيانات العميل ${name}`
        });

        bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
        customerManager.loadCustomers();
        alert('تم تحديث بيانات العميل بنجاح');
      }

      async function deleteCustomer(id) {
        const F = window.firebaseDB_instance;
        const customer = await F.getCustomerById(id);
        if (!customer) return;

        // Optional: prevent delete if has active subscription (safer UX)
        const sub = await F.getActiveSubscriptionByCustomerId(id);
        if (sub) {
          alert('لا يمكن حذف العميل لأنه يملك اشتراكًا نشطًا. أوقف/احذف الاشتراك أولاً.');
          return;
        }

        if (confirm(`هل أنت متأكد من حذف العميل ${customer.name || ''}؟`)) {
          await F.logActivity({
            type: 'حذف عميل',
            customerId: id,
            description: `تم حذف العميل ${customer.name || ''}`
          });

          await F.deleteCustomer(id);
          customerManager.loadCustomers();
          alert('تم حذف العميل بنجاح');
        }
      }

      // Initialize when Firebase is ready and DOM is loaded
      let customerManager;
      document.addEventListener('DOMContentLoaded', async function () {
        try {
          console.log('DOM loaded, waiting for Firebase...');
          await waitForFirebaseInstance();
          console.log('Firebase instance ready:', window.firebaseDB_instance);
          customerManager = new CustomerManager();
        } catch (e) {
          console.error('Initialization error:', e);
          alert('تعذّر تحميل البيانات. يرجى تحديث الصفحة.\nError: ' + e.message);
        }
      });

      // Logout
      function logout() {
        if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
          localStorage.removeItem('isLoggedIn');
          localStorage.removeItem('username');
          window.location.href = 'login.html';
        }
      }
    </script>
    
    <!-- Firebase SDK -->
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="online-database.js"></script>
</body>
</html>

