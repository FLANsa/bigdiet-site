<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Registration - Healthy Food Subscription System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <style>
        .table thead th {
            padding: 15px 20px !important;
            font-size: 0.9rem !important;
            font-weight: 600 !important;
            min-width: 120px !important;
            text-align: center !important;
        }
        .table thead th:first-child {
            border-top-left-radius: 0 !important;
            border-bottom-left-radius: 0 !important;
        }
        .table thead th:last-child {
            border-top-right-radius: 0 !important;
            border-bottom-right-radius: 0 !important;
            border-top-left-radius: 15px !important;
            border-bottom-left-radius: 15px !important;
        }

        .table tbody td {
            padding: 15px 20px !important;
            text-align: center !important;
            vertical-align: middle !important;
        }
        .table tbody td:first-child {
            text-align: center !important;
            font-family: monospace !important;
        }
        .table tbody td:nth-child(2),
        .table tbody td:nth-child(3),
        .table tbody td:nth-child(5) {
            text-align: center !important;
            padding: 15px 10px !important;
        }
        .table tbody td:nth-child(4) {
            text-align: center !important;
            font-weight: 600 !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">big diet</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">لوحة التحكم</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="customers.html">العملاء</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="subscriptions.html">الاشتراكات</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="daily-registration.html">التسجيل اليومي</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="packages.html">الباقات</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button class="btn btn-outline-danger btn-sm" onclick="logout()">تسجيل الخروج</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <h1 class="mb-4">التسجيل اليومي للوجبات</h1>
        
        <!-- Registration Form -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">تسجيل جديد</h5>
                    </div>
                    <div class="card-body">
                        <form id="registrationForm">
                            <div class="mb-3">
                                <label for="customerSearch" class="form-label">البحث عن العميل</label>
                                <input type="text" class="form-control" id="customerSearch" placeholder="أدخل اسم العميل أو رقم الهاتف">
                                <div id="searchResults" class="mt-2"></div>
                            </div>
                            <div class="mb-3" id="selectedCustomerInfo" style="display: none;">
                                <div class="alert alert-info">
                                    <strong>العميل المحدد:</strong> <span id="selectedCustomerName"></span><br>
                                    <strong>الوجبات المتبقية:</strong> <span id="remainingMeals"></span><br>
                                    <strong>السناكس المتبقية:</strong> <span id="remainingSnacks"></span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="mealType" class="form-label">تسجيل الوجبات</label>
                                <select class="form-select" id="mealType">
                                    <option value="">-- اختر عدد الوجبات --</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="snackType" class="form-label">تسجيل السناكس</label>
                                <select class="form-select" id="snackType">
                                    <option value="">-- اختر عدد السناكس --</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="registrationTime" class="form-label">وقت التسجيل</label>
                                <input type="time" class="form-control" id="registrationTime" readonly>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">تسجيل الحضور</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Today's Registrations -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">تسجيلات اليوم</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>الوقت</th>
                                        <th>اسم العميل</th>
                                        <th>نوع التسجيل</th>
                                        <th>الكمية</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="todayRegistrationsTableBody">
                                    <!-- Today's registrations will be loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Visits Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card" id="recentVisitsSection" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">آخر الزيارات</h5>
                    </div>
                    <div class="card-body" id="recentVisitsList">
                        <!-- Recent visits will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="database.js"></script>
    <script>
        // Check authentication
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'login.html';
        }

        // Daily Registration Management
        class DailyRegistrationManager {
            constructor() {
                this.selectedCustomer = null;
                this.init();
            }

            init() {
                this.setCurrentTime();
                this.loadTodayRegistrations();
                this.setupEventListeners();
            }

            setCurrentTime() {
                const now = new Date();
                const timeString = now.toTimeString().slice(0, 5);
                document.getElementById('registrationTime').value = timeString;
            }

            setupEventListeners() {
                // Customer search
                document.getElementById('customerSearch').addEventListener('input', (e) => {
                    this.searchCustomers(e.target.value);
                });

                // Form submission
                document.getElementById('registrationForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitRegistration();
                });
            }

            searchCustomers(query) {
                const searchResults = document.getElementById('searchResults');
                
                if (query.length < 2) {
                    searchResults.innerHTML = '';
                    return;
                }

                const customers = db.searchCustomers(query);
                searchResults.innerHTML = '';

                if (customers.length === 0) {
                    searchResults.innerHTML = '<div class="text-muted">لا يوجد عملاء</div>';
                    return;
                }

                customers.forEach(customer => {
                    const div = document.createElement('div');
                    div.className = 'border rounded p-2 mb-1 cursor-pointer';
                    div.style.cursor = 'pointer';
                    div.innerHTML = `
                        <strong>${customer.name}</strong><br>
                        <small class="text-muted">${customer.phone}</small>
                    `;
                    div.addEventListener('click', () => {
                        this.selectCustomer(customer);
                    });
                    searchResults.appendChild(div);
                });
            }

            selectCustomer(customer) {
                this.selectedCustomer = customer;
                const subscription = db.getSubscriptionByCustomerId(customer.id);
                
                // Show customer info
                document.getElementById('selectedCustomerName').textContent = customer.name;
                document.getElementById('remainingMeals').textContent = subscription ? subscription.remainingMeals : 0;
                document.getElementById('remainingSnacks').textContent = subscription ? subscription.remainingSnacks : 0;
                document.getElementById('selectedCustomerInfo').style.display = 'block';
                
                // Clear search
                document.getElementById('customerSearch').value = '';
                document.getElementById('searchResults').innerHTML = '';

                // Update meal and snack dropdowns
                this.updateMealSnackDropdowns(subscription);

                // Load and show recent visits
                this.loadRecentVisits(customer.id);
            }

            updateMealSnackDropdowns(subscription) {
                const mealSelect = document.getElementById('mealType');
                const snackSelect = document.getElementById('snackType');
                
                // Clear existing options
                mealSelect.innerHTML = '<option value="">-- اختر عدد الوجبات --</option>';
                snackSelect.innerHTML = '<option value="">-- اختر عدد السناكس --</option>';

                if (!subscription) {
                    mealSelect.innerHTML += '<option value="0" disabled>لا يوجد اشتراك نشط</option>';
                    snackSelect.innerHTML += '<option value="0" disabled>لا يوجد اشتراك نشط</option>';
                    return;
                }

                // Add meal options (1 to remaining meals)
                for (let i = 1; i <= subscription.remainingMeals; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    if (i === 1) option.textContent = 'وجبة واحدة';
                    else if (i === 2) option.textContent = 'وجبتين';
                    else option.textContent = `${i} وجبات`;
                    mealSelect.appendChild(option);
                }

                // Add snack options (1 to remaining snacks)
                for (let i = 1; i <= subscription.remainingSnacks; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    if (i === 1) option.textContent = 'سناك واحد';
                    else if (i === 2) option.textContent = 'سناكين';
                    else option.textContent = `${i} سناكس`;
                    snackSelect.appendChild(option);
                }
            }

            submitRegistration() {
                if (!this.selectedCustomer) {
                    alert('يرجى اختيار العميل أولاً');
                    return;
                }

                const meals = parseInt(document.getElementById('mealType').value) || 0;
                const snacks = parseInt(document.getElementById('snackType').value) || 0;

                if (meals === 0 && snacks === 0) {
                    alert('يرجى اختيار وجبة أو سناك واحد على الأقل');
                    return;
                }

                const subscription = db.getSubscriptionByCustomerId(this.selectedCustomer.id);
                if (!subscription) {
                    alert('العميل لا يملك اشتراك نشط');
                    return;
                }

                if (meals > subscription.remainingMeals) {
                    alert('عدد الوجبات المطلوبة أكبر من المتبقي');
                    return;
                }

                if (snacks > subscription.remainingSnacks) {
                    alert('عدد السناكس المطلوبة أكبر من المتبقي');
                    return;
                }

                // Add registration
                const registration = db.addDailyRegistration({
                    customerId: this.selectedCustomer.id,
                    meals: meals,
                    snacks: snacks
                });

                if (registration) {
                    alert('تم تسجيل الحضور بنجاح');
                    this.resetForm();
                    this.loadTodayRegistrations();
                }
            }

            resetForm() {
                this.selectedCustomer = null;
                document.getElementById('registrationForm').reset();
                document.getElementById('selectedCustomerInfo').style.display = 'none';
                document.getElementById('recentVisitsSection').style.display = 'none';
                document.getElementById('searchResults').innerHTML = '';
                this.setCurrentTime();
            }

            loadRecentVisits(customerId) {
                const recentVisits = db.getCustomerRegistrations(customerId, 5);
                const recentVisitsContainer = document.getElementById('recentVisitsList');
                const recentVisitsSection = document.getElementById('recentVisitsSection');
                
                if (recentVisits.length === 0) {
                    recentVisitsContainer.innerHTML = '<p class="text-muted text-center">لا توجد زيارات سابقة</p>';
                } else {
                    recentVisitsContainer.innerHTML = '';
                    recentVisits.forEach(visit => {
                        const visitDiv = document.createElement('div');
                        visitDiv.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
                        
                        const description = this.formatRegistrationDescription(visit);
                        visitDiv.innerHTML = `
                            <div>
                                <strong>${visit.date}</strong><br>
                                <small class="text-muted">${description}</small>
                            </div>
                            <div>
                                <span class="badge bg-primary">${visit.time}</span>
                            </div>
                        `;
                        recentVisitsContainer.appendChild(visitDiv);
                    });
                }

                // Show recent visits section
                recentVisitsSection.style.display = 'block';
            }

            loadTodayRegistrations() {
                const registrations = db.getTodayRegistrations();
                const tbody = document.getElementById('todayRegistrationsTableBody');
                tbody.innerHTML = '';

                if (registrations.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">لا توجد تسجيلات اليوم</td></tr>';
                    return;
                }

                registrations.forEach(registration => {
                    const customer = db.getCustomerById(registration.customerId);
                    const registrationType = this.getRegistrationType(registration);
                    const quantity = this.getRegistrationQuantity(registration);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${registration.time}</td>
                        <td>${customer ? customer.name : 'عميل غير معروف'}</td>
                        <td>${registrationType}</td>
                        <td>${quantity}</td>
                        <td><span class="badge bg-success">مكتمل</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRegistration(${registration.id})">حذف</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            getRegistrationType(registration) {
                if (registration.meals > 0 && registration.snacks > 0) {
                    return 'وجبات وسناكس';
                } else if (registration.meals > 0) {
                    return 'وجبات';
                } else if (registration.snacks > 0) {
                    return 'سناكس';
                }
                return 'غير محدد';
            }

            getRegistrationQuantity(registration) {
                let quantity = '';
                if (registration.meals > 0) {
                    if (registration.meals === 1) quantity += 'وجبة واحدة';
                    else if (registration.meals === 2) quantity += 'وجبتين';
                    else quantity += `${registration.meals} وجبات`;
                }
                
                if (registration.snacks > 0) {
                    if (quantity) quantity += ' + ';
                    if (registration.snacks === 1) quantity += 'سناك واحد';
                    else if (registration.snacks === 2) quantity += 'سناكين';
                    else quantity += `${registration.snacks} سناكس`;
                }

                return quantity || 'غير محدد';
            }

            formatRegistrationDescription(registration) {
                return this.getRegistrationQuantity(registration);
            }
        }

        // Global functions
        function deleteRegistration(id) {
            if (confirm('هل أنت متأكد من حذف هذا التسجيل؟')) {
                // Find and remove registration
                const data = db.getData();
                const registration = data.dailyRegistrations.find(r => r.id === id);
                
                if (registration) {
                    // Restore meals/snacks to subscription
                    const subscription = data.subscriptions.find(s => 
                        s.customerId === registration.customerId && s.status === 'نشط'
                    );
                    
                    if (subscription) {
                        subscription.remainingMeals += registration.meals;
                        subscription.remainingSnacks += registration.snacks;
                    }

                    // Remove registration
                    data.dailyRegistrations = data.dailyRegistrations.filter(r => r.id !== id);
                    db.saveData(data);

                    // Add activity
                    const customer = db.getCustomerById(registration.customerId);
                    db.addActivity({
                        type: 'حذف تسجيل',
                        customerId: registration.customerId,
                        description: `تم حذف تسجيل العميل ${customer ? customer.name : 'غير معروف'}`
                    });

                    // Refresh table
                    dailyRegistrationManager.loadTodayRegistrations();
                    alert('تم حذف التسجيل بنجاح');
                }
            }
        }

        // Initialize daily registration manager
        let dailyRegistrationManager;
        document.addEventListener('DOMContentLoaded', function() {
            dailyRegistrationManager = new DailyRegistrationManager();
        });

        // Logout function
        function logout() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('username');
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>

